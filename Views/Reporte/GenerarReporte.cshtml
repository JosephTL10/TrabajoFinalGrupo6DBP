@{
    ViewData["Title"] = "Generar Reporte - Hospital Loayza";
}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        body {
            background: #eef3f7;
            font-family: 'Segoe UI', sans-serif;
        }

        .hero {
            background: linear-gradient(90deg, #007bff, #004a99);
            color: white;
            padding: 40px 0;
            text-align: center;
            border-radius: 0 0 25px 25px;
        }

        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-custom {
            background-color: #007bff;
            color: white;
            border-radius: 10px;
            transition: 0.3s;
        }

        .btn-custom:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        #spinner {
            display: none;
        }
    </style>
</head>

<body>
    <div class="hero">
        <h1><i class="bi bi-clipboard-data"></i> Generar Reporte</h1>
        <p>Consulta la información del hospital de manera dinámica y detallada</p>
    </div>

    <div class="container mt-5 mb-5">
        <div class="card p-4">
            <form asp-action="GenerarReporte" method="post" id="formReporte">
                <div class="mb-3">
                    <label class="form-label fw-bold">Tipo de Reporte</label>
                    <select class="form-select" id="tipoReporte" name="tipoReporte" required>
                        <option value="">Seleccione...</option>
                        <option value="pacientes">Pacientes</option>
                        <option value="citas">Citas Médicas</option>
                        <option value="estadisticas">Estadísticas</option>
                    </select>
                </div>

                <div id="filtrosDinamicos" class="row g-3"></div>

                <div class="d-flex justify-content-center mt-4">
                    <button type="submit" class="btn btn-custom me-2">
                        <i class="bi bi-search"></i> Generar
                    </button>
                    <button type="reset" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                </div>
            </form>
        </div>

        <div id="spinner" class="text-center mt-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 text-muted">Generando reporte...</p>
        </div>

        <!-- Resultados -->
        <div class="card mt-4 p-4">
            <h5 class="text-primary"><i class="bi bi-bar-chart"></i> Resultados del Reporte</h5>
            <div id="resultado" class="mt-3">
                @if (ViewBag.TipoReporte == "pacientes")
                {
                    if (ViewBag.Resultados != null &&
                    ((List<TrabajoFinalGrupo6DBP.Models.Paciente>)ViewBag.Resultados).Count > 0)
                    {
                        <table class="table table-bordered table-striped">
                            <thead class="table-primary">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>DNI</th>
                                    <th>Teléfono</th>

                                    <th>Dirección</th>

                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var p in ViewBag.Resultados)
                                {
                                    <tr>
                                        <td>@p.Id_Paciente</td>
                                        <td>@p.Nombre_Completo_Paciente</td>
                                        <td>@p.DNI_Paciente</td>
                                        <td>@p.Telefono_Paciente</td>
                                        <td>@p.Direccion_Paciente</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted text-center">No se encontraron pacientes.</p>
                    }
                }
                else if (ViewBag.TipoReporte == "citas")
                {
                    if (ViewBag.Resultados != null &&
                    ((List<TrabajoFinalGrupo6DBP.Models.CitaMedica>)ViewBag.Resultados).Count > 0)
                    {
                        <table class="table table-bordered table-striped">
                            <thead class="table-primary">
                                <tr>
                                    <th>ID</th>
                                    <th>Paciente</th>
                                    <th>Especialidad</th>
                                    <th>Médico</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var c in ViewBag.Resultados)
                                {
                                    <tr>
                                        <td>@c.Id_CitaMedica</td>
                                        <td>@c.Paciente?.Nombre_Completo_Paciente</td>

                                        <td>@c.Medico?.Especialidad?.Nombre_Especialidad</td>

                                        <td>@c.Medico?.Nombre_Completo_Medico</td>

                                        <td>@c.Fecha_CitaMedica.ToShortDateString()</td>
                                        <td>@c.Hora_CitaMedica</td>
                                        <td>@c.Estado_CitaMedica</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted text-center">No se encontraron citas.</p>
                    }
                }
                else if (ViewBag.TipoReporte == "estadisticas")
                {
                    if (ViewBag.Estadisticas != null)
                    {
                        <table class="table table-bordered table-striped">
                            <thead class="table-primary">
                                <tr>
                                    <th>Categoría</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var e in ViewBag.Estadisticas)
                                {
                                    <tr>
                                        <td>@e.Categoria</td>
                                        <td>@e.Total</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted text-center">Seleccione un tipo de estadística.</p>
                    }
                }
                else
                {
                    <p class="text-muted text-center"><i class="bi bi-info-circle"></i> Seleccione un tipo de reporte y
                        presione <strong>Generar</strong>.</p>
                }
            </div>



            <!-- Div para mostrar graficos de estadisticas -->
            <div class="mt-4">
                <canvas id="graficoEstadisticas" style="max-height: 350px;"></canvas>
            </div>

        </div>




        @if (ViewBag.Mensaje != null)
        {
            <div class="alert alert-warning mt-4 text-center">
                <i class="bi bi-exclamation-triangle"></i> @ViewBag.Mensaje
            </div>
        }
    </div>



    <script>
        const tipoReporte = document.getElementById("tipoReporte");
        const filtros = document.getElementById("filtrosDinamicos");
        const spinner = document.getElementById("spinner");

        tipoReporte.addEventListener("change", function () {
            const tipo = this.value;
            filtros.innerHTML = "";

            if (tipo === "pacientes") {
                filtros.innerHTML = `
                    <div class="col-md-6">
                        <label class="form-label">Filtro</label>
                        <select class="form-select" name="filtroPaciente">
                            <option value="">Seleccione...</option>
                            <option value="porNombre">Por nombre</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nombre</label>
                        <input type="text" name="nombrePacienteFiltro" class="form-control" placeholder="Ingrese el nombre">
                    </div>`;
            } else if (tipo === "citas") {
                filtros.innerHTML = `
                    <div class="col-md-6">
                        <label class="form-label">Filtro</label>
                        <select class="form-select" name="filtroCita">
                            <option value="">Seleccione...</option>
                            <option value="fecha">Por fecha</option>
                            <option value="especialidad">Por especialidad</option>
                            <option value="estado">Por estado</option>
                            <option value="paciente">Por paciente</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Especialidad</label>
                        <select class="form-select" name="especialidad">
                            <option value="">Selecciona una especialidad</option>
                            @if (ViewBag.Especialidades != null)
                            {
                                    @foreach (var especialidad in ViewBag.Especialidades)
                                    {
                                            <option value="@especialidad.Nombre_Especialidad">@especialidad.Nombre_Especialidad</option>
                                    }

                            }
                            else
                            {
                                    <option>No hay especialidades registradas</option>
                            }

                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Estado</label>
                        <select class="form-select" name="estado">
                            <option value="">Seleccione...</option>
                            <option value="Confirmada">Confirmada</option>
                            <option value="Cancelada">Cancelada</option>
                            <option value="En proceso">En proceso</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nombre del Paciente</label>
                        <input type="text" name="nombrePaciente" class="form-control" placeholder="Ingrese el nombre">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Desde</label>
                        <input type="date" name="fechaInicio" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Hasta</label>
                        <input type="date" name="fechaFin" class="form-control">
                    </div>`;
            } else if (tipo === "estadisticas") {
                filtros.innerHTML = `
                    <div class="col-md-12">
                        <label class="form-label">Tipo de Estadística</label>
                        <select class="form-select" name="tipoEstadistica">
                            <option value="">Seleccione...</option>
                            <option value="porEspecialidad">Citas por Especialidad</option>
                            <option value="porEstado">Citas por Estado</option>
                            <option value="porMes">Citas por Mes</option>
                        </select>
                    </div>`;
            }
        });

        document.getElementById("formReporte").addEventListener("submit", function () {
            spinner.style.display = "block";
        });
    </script>





    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const tipo = "@ViewBag.TipoReporte";

            if (tipo === "estadisticas") {

                const labels = @Html.Raw(Json.Serialize(ViewBag.Labels));
                const data = @Html.Raw(Json.Serialize(ViewBag.Data));

                const ctx = document.getElementById('graficoEstadisticas');

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total',
                            data: data,
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderColor: 'rgba(0,0,0,0.2)',
                            borderWidth: 1,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        });
    </script>


</body>

</html>