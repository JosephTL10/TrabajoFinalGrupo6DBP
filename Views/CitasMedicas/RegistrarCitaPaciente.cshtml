@{
    ViewData["Title"] = "Registrar Cita M√©dica";
}
@model TrabajoFinalGrupo6DBP.Models.CitaMedica

<style>
.container {
    max-width: 700px;
    margin: 20px auto;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
h1 {
    color: #0066cc;
    font-weight: bold;
    text-align: center;
    margin-bottom: 20px;
}
label {
    font-weight: bold;
    margin-top: 10px;
}
.btn {
    border-radius: 4px;
}
#infoHorario {
    background-color: #eaf4ff;
    border-left: 4px solid #0066cc;
    padding: 10px;
    margin-top: 10px;
    display: none;
}
</style>

<div class="container">
    <h1>Registrar Cita M√©dica</h1>
    <p class="text-muted text-center mb-4">
        Selecciona un paciente y un m√©dico disponible seg√∫n su horario.
    </p>

    <form asp-action="RegistrarCitaPaciente" method="post">

        <!-- PACIENTE -->
        <div class="form-group">
            <label for="DNI_Paciente">DNI del Paciente *</label>
            <input type="text" id="DNI_Paciente" class="form-control" maxlength="8" placeholder="Ingrese el DNI" required />
            <input type="hidden" id="PacienteId" name="PacienteId" />
            <div id="datosPaciente" class="alert alert-info mt-2" style="display:none;">
                <strong>Paciente:</strong> <span id="nombrePaciente"></span> (Edad: <span id="edadPaciente"></span>)
            </div>
        </div>

        

        <!-- ESPECIALIDAD -->
        <div class="form-group">
            <label for="Especialidad">Especialidad *</label>
            
            <select id="Especialidad" name="Id_Especialidad" class="form-control" required
                asp-items="ViewBag.Especialidades">
            </select>

        </div>

        <!-- M√âDICO -->
        <div class="form-group">
            <label for="MedicoId">M√©dico *</label>
            <select id="MedicoId" name="MedicoId" class="form-control" required disabled>
                <option value="">Seleccione una especialidad primero</option>
            </select>
        </div>

        <!-- HORARIO DISPONIBLE -->
        <div id="infoHorario"></div>


        <!-- FECHA Y HORA -->
        <div class="form-group">
            <label for="Fecha_CitaMedica">Fecha de la Cita *</label>
            <input type="date" asp-for="Fecha_CitaMedica" class="form-control" required min="@DateTime.Now.ToString("yyyy-MM-dd")" />
        </div>

        <div class="form-group">
            <label asp-for="Hora_CitaMedica">Hora de la Cita</label>
            <select asp-for="Hora_CitaMedica" id="Hora_CitaMedica" class="form-control" required>
                <option value="">Seleccione un horario</option>
            </select>
            <small id="infoBloques" class="text-muted"></small>
        </div>


        <!-- OBSERVACIONES -->
        <div class="form-group">
            <label asp-for="Observaciones">Observaciones</label>
            <textarea asp-for="Observaciones" class="form-control" rows="3"></textarea>
        </div>

        <!-- BOTONES -->
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary">Registrar Cita</button>
            <a asp-action="ListaCitasMedicas" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

@section Scripts {
<script>
    // üîç Buscar paciente por DNI
    document.getElementById("DNI_Paciente").addEventListener("blur", function() {
        const dni = this.value.trim();
        if (dni.length === 8) {
            fetch(`/Pacientes/BuscarPorDNI?dni=${dni}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.id) {
                        document.getElementById("PacienteId").value = data.id;
                        document.getElementById("nombrePaciente").textContent = data.nombreCompleto;
                        document.getElementById("edadPaciente").textContent = data.edad;
                        document.getElementById("datosPaciente").style.display = "block";
                    } else {
                        alert("Paciente no encontrado. Reg√≠stralo primero.");
                        document.getElementById("datosPaciente").style.display = "none";
                    }
                });
        }
    });

    // üîÑ Cargar m√©dicos por especialidad
    document.getElementById("Especialidad").addEventListener("change", function() {
        const especialidad = this.value;
        const medicoSelect = document.getElementById("MedicoId");

        medicoSelect.innerHTML = "";
        medicoSelect.disabled = true;
        document.getElementById("infoHorario").style.display = "none";

        if (especialidad) {
            fetch(`/api/medicos/porEspecialidad?especialidadId=${encodeURIComponent(especialidad)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        medicoSelect.disabled = false;
                        medicoSelect.innerHTML = "<option value=''>Seleccione un m√©dico</option>";
                        data.forEach(m => {
                            medicoSelect.innerHTML += `<option value="${m.id}">${m.nombre}</option>`;
                        });
                    } else {
                        medicoSelect.innerHTML = "<option value=''>No hay m√©dicos activos en esta especialidad</option>";
                    }
                });
        }
    });

    // üïê Mostrar horarios del m√©dico seleccionado
    document.getElementById("MedicoId").addEventListener("change", function() {
        const medicoId = this.value;
        const infoDiv = document.getElementById("infoHorario");

        if (medicoId) {
            fetch(`/api/horarios/porMedico?id=${medicoId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        let texto = "<strong>Horarios de atenci√≥n:</strong><ul>";
                        data.forEach(h => {
                            texto += `<li>${h.dia}: ${h.horaInicio} - ${h.horaFin}</li>`;
                        });
                        texto += "</ul>";
                        infoDiv.innerHTML = texto;
                        infoDiv.style.display = "block";
                    } else {
                        infoDiv.innerHTML = "<em>El m√©dico no tiene horarios registrados.</em>";
                        infoDiv.style.display = "block";
                    }
                });
        } else {
            infoDiv.style.display = "none";
        }
    });



    // ‚è∞ Cargar bloques horarios disponibles seg√∫n fecha y m√©dico
    // üîÑ Cargar bloques disponibles seg√∫n m√©dico y fecha
    function cargarBloques() {
        const medicoId = document.getElementById("MedicoId").value;
        const fecha = document.getElementById("Fecha_CitaMedica").value;
        const selectHora = document.getElementById("Hora_CitaMedica");
        const info = document.getElementById("infoBloques");

        if (!medicoId || !fecha) return;

        fetch(`/api/bloques/disponibles?medicoId=${medicoId}&fecha=${fecha}`)
            .then(res => res.json())
            .then(data => {
                selectHora.innerHTML = "";
                if (data.length === 0) {
                    selectHora.innerHTML = "<option>No hay horario disponible ese d√≠a</option>";
                    info.textContent = "";
                return;
            }

            let hayDisponibles = false;
            data.forEach(b => {
                const option = document.createElement("option");
                option.value = b.hora;
                option.textContent = b.hora + (b.ocupado ? " (Ocupado)" : "");
                option.disabled = b.ocupado;
                selectHora.appendChild(option);
                if (!b.ocupado) hayDisponibles = true;
            });

            info.textContent = hayDisponibles
                ? "Seleccione una hora disponible."
                : "No hay horas disponibles para este m√©dico en esa fecha.";
        });
    }

    // üóì Escuchar cambios
    document.getElementById("Fecha_CitaMedica").addEventListener("change", cargarBloques);
    document.getElementById("MedicoId").addEventListener("change", cargarBloques);

</script>
}
